{% extends "base.html" %}
{% block content %}

<!-- ===== LOADING OVERLAY ===== -->
<div id="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <h5>â³ Menghitung Analytics...</h5>
        <p>Mohon tunggu sebentar</p>
    </div>
</div>

<h2 class="fw-bold text-center mb-4" style="color:var(--text);">
    ğŸ’° Analisis Keuangan Bulan Ini
</h2>

<!-- ===== RINGKASAN UTAMA ===== -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="p-3 rounded analytics-section text-center summary-card-analytics">
            <small style="color:var(--link);">Total Pemasukan</small>
            <h4 class="fw-bold mt-1" style="color:#34d399;">Rp {{ "{:,}".format(pemasukan|int) }}</h4>
        </div>
    </div>
    <div class="col-md-3">
        <div class="p-3 rounded box-section text-center">
            <small style="color:var(--link);">Total Pengeluaran</small>
            <h4 class="fw-bold mt-1" style="color:#f87171;">Rp {{ "{:,}".format(pengeluaran|int) }}</h4>
        </div>
    </div>
    <div class="col-md-3">
        <div class="p-3 rounded box-section text-center">
            <small style="color:var(--link);">Sisa Bulan Ini</small>
            <h4 class="fw-bold mt-1" style="color:#60a5fa;">Rp {{ "{:,}".format(sisa|int) }}</h4>
        </div>
    </div>
    <div class="col-md-3">
        <div class="p-3 rounded box-section text-center">
            <small style="color:var(--link);">Target Nabung</small>
            <h4 class="fw-bold mt-1" style="color:#a78bfa;">Rp {{ "{:,}".format(target_nabung|int) }}</h4>
        </div>
    </div>
</div>

<!-- ===== INPUT TARGET (SINGLE FORM - FIXED) ===== -->
<div class="p-3 rounded mb-4 box-section">
    <form id="budget-form" method="POST" class="row g-2 align-items-center">
        <div class="col-md-3">
            <input type="number" name="target" id="target-input" class="form-control" placeholder="Target menabung (Rp)"
                value="{{ target_nabung if target_nabung else '' }}"
                style="background: var(--card-bg); color: var(--text); border-color: var(--card-border);" required>
        </div>

        <!-- ===== LIFESTYLE SELECTOR (MOVED HERE) ===== -->
        <div class="col-md-3">
            <select name="lifestyle" id="lifestyle-select" class="form-select"
                style="background: var(--card-bg); color: var(--text); border-color: var(--card-border);">
                <option value="hemat" {% if lifestyle=='hemat' %}selected{% endif %}>ğŸŸ¦ Hemat</option>
                <option value="moderat" {% if lifestyle=='moderat' %}selected{% endif %}>ğŸŸ© Moderat</option>
                <option value="aktif" {% if lifestyle=='aktif' %}selected{% endif %}>ğŸŸ§ Aktif</option>
            </select>
        </div>

        <div class="col-md-3">
            <button type="submit" class="btn btn-info fw-bold w-100">ğŸ”„ atur target menabung </button>
        </div>

        <div class="col-md-3 text-end">
            <small style="color:var(--link);">Preset:</small>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-1"
                onclick="setTarget(300000)">300k</button>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-1"
                onclick="setTarget(500000)">500k</button>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-1"
                onclick="setTarget(1000000)">1jt</button>
        </div>
    </form>
</div>

<!-- ===== EMERGENCY WARNING ===== -->
{% if emergency_warning %}
<div class="alert-custom mb-4"
    style="background:{% if emergency_warning.level == 'critical' %}rgba(248,113,113,0.15){% else %}rgba(251,191,36,0.15){% endif %}; border-left:4px solid {% if emergency_warning.level == 'critical' %}#f87171{% else %}#fbbf24{% endif %};">
    <h6 class="fw-bold mb-2" style="color:var(--text);">
        {% if emergency_warning.level == 'critical' %}ğŸš¨ PERINGATAN KRITIS{% else %}âš ï¸ PERINGATAN{% endif %}
    </h6>
    <p class="mb-2" style="color:var(--text);">{{ emergency_warning.message }}</p>
    <p class="mb-0 small" style="color:var(--link);">
        ğŸ’¡ Batasi pengeluaran maksimal <strong>Rp {{ "{:,}".format(emergency_warning.daily_limit|int) }}/hari</strong>
        untuk sisa bulan ini.
    </p>
</div>
{% endif %}

<!-- ===== PREDIKSI STATUS ===== -->
{% if prediction_message %}
<div class="p-3 rounded mb-4 box-section"
    style="border-left:5px solid {% if prediction_status == 'Boros' %}#f87171{% elif prediction_status == 'Waspada' %}#fbbf24{% else %}#34d399{% endif %};">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h6 class="fw-bold mb-1" style="color:var(--text);">
                {% if prediction_status == 'Boros' %}âš ï¸{% elif prediction_status == 'Waspada' %}âš¡{% else %}âœ…{% endif %}
                {{ prediction_message }}
            </h6>
            <small style="color:var(--link);">Prediksi berdasarkan pola spending minggu ini</small>
        </div>
        <span class="badge px-3 py-2"
            style="background:{% if prediction_status == 'Boros' %}#f87171{% elif prediction_status == 'Waspada' %}#fbbf24{% else %}#34d399{% endif %}; color:white;">
            {{ prediction_status }}
        </span>
    </div>
</div>
{% endif %}

<!-- BUDGET HARI INI & WEEKLY PROGRESS ===== -->
<div class="row g-3 mb-4">
    <!-- Budget Hari Ini -->
    <div class="col-md-6">
        <div class="p-3 rounded box-section">
            <!-- HEADER YANG BENAR -->
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h6 class="fw-bold mb-1" style="color:var(--text);">ğŸ“… Budget Hari Ini</h6>
                    <small style="color:var(--link);">{{ daily_status.date }}</small>
                </div>
                <div class="text-end">
                    <div class="budget-percentage fw-bold fs-5" 
                         style="color:{% if daily_status.status == 'success' %}#34d399{% elif daily_status.status == 'warning' %}#fbbf24{% else %}#f87171{% endif %};">
                        {{ daily_status.percentage|round(1) }}%
                    </div>
                </div>
            </div>

            <!-- DATA BUDGET - KONDISI YANG BENAR -->
            {% if daily_status.budget_limit > 0 or daily_status.spent > 0 %}
            <div class="budget-details">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color:var(--text);">Limit Harian:</span>
                    <strong style="color:var(--text);">Rp {{ "{:,}".format(daily_status.budget_limit|int) }}</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color:var(--text);">Sudah Keluar:</span>
                    <strong style="color:{% if daily_status.status == 'success' %}#34d399{% elif daily_status.status == 'warning' %}#fbbf24{% else %}#f87171{% endif %};">
                        Rp {{ "{:,}".format(daily_status.spent|int) }}
                    </strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span style="color:var(--text);">Sisa Budget:</span>
                    <strong style="color:{% if daily_status.remaining >= 0 %}#34d399{% else %}#f87171{% endif %};">
                        Rp {{ "{:,}".format(daily_status.remaining|int) }}
                    </strong>
                </div>
                
                <!-- PROGRESS BAR -->
                <div class="analytics-progress mb-3">
                    <div class="analytics-progress-bar {% if daily_status.status == 'success' %}progress-success{% elif daily_status.status == 'warning' %}progress-warning{% else %}progress-danger{% endif %}"
                         style="width:{{ daily_status.percentage if daily_status.percentage <= 100 else 100 }}%;">
                        <strong>{{ daily_status.percentage|round(1) }}%</strong>
                    </div>
                </div>
                
                <!-- STATUS MESSAGE -->
                <div class="text-center">
                    <small style="color:var(--link);">
                        {% if daily_status.spent == 0 %}
                        âœ¨ Belum ada pengeluaran hari ini
                        {% elif daily_status.status == 'success' %}
                        âœ… ON TRACK
                        {% elif daily_status.status == 'warning' %}
                        âš ï¸ MENDEKATI LIMIT
                        {% else %}
                        âŒ OVER BUDGET
                        {% endif %}
                    </small>
                </div>
            </div>
            {% else %}
            <!-- TAMPILAN JIKA BELUM ADA DATA -->
            <div class="text-center py-4">
                <div class="mb-3">
                    <span style="font-size: 3rem;">ğŸ’°</span>
                </div>
                <small style="color:var(--link);">
                    ğŸ’¡ Tambahkan data pemasukan dan pengeluaran untuk melihat budget harian
                </small>
                <div class="mt-3">
                    <a href="{{ url_for('add_income') }}" class="btn btn-sm btn-outline-info me-2">â• Tambah Pemasukan</a>
                    <a href="{{ url_for('add_expense') }}" class="btn btn-sm btn-outline-warning">â– Tambah Pengeluaran</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Progress Mingguan -->
    <div class="col-md-6">
        <div class="p-3 rounded box-section">
            <!-- HEADER YANG BENAR -->
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h6 class="fw-bold mb-1" style="color:var(--text);">ğŸ“Š Progress Minggu Ke-{{ weekly_progress.week_num }}</h6>
                    <small style="color:var(--link);">Target vs Realisasi</small>
                </div>
                <div class="text-end">
                    <div class="budget-percentage fw-bold fs-5" 
                         style="color:{% if weekly_progress.status == 'success' %}#34d399{% elif weekly_progress.status == 'warning' %}#fbbf24{% else %}#f87171{% endif %};">
                        {{ weekly_progress.percentage|round(1) }}%
                    </div>
                </div>
            </div>

            {% if weekly_progress.target > 0 or weekly_progress.spending > 0 %}
            <div class="budget-details">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color:var(--text);">Target Mingguan:</span>
                    <strong style="color:var(--text);">Rp {{ "{:,}".format(weekly_progress.target|int) }}</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color:var(--text);">Total Spending:</span>
                    <strong style="color:{% if weekly_progress.status == 'success' %}#34d399{% elif weekly_progress.status == 'warning' %}#fbbf24{% else %}#f87171{% endif %};">
                        Rp {{ "{:,}".format(weekly_progress.spending|int) }}
                    </strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span style="color:var(--text);">Sisa Budget:</span>
                    <strong style="color:{% if weekly_progress.remaining >= 0 %}#34d399{% else %}#f87171{% endif %};">
                        Rp {{ "{:,}".format(weekly_progress.remaining|int) }}
                    </strong>
                </div>
                
                <!-- PROGRESS BAR -->
                <div class="progress mb-3" style="height:25px;">
                    <div class="progress-bar"
                         style="width:{{ weekly_progress.percentage if weekly_progress.percentage <= 100 else 100 }}%; 
                                background:{% if weekly_progress.status == 'success' %}#34d399{% elif weekly_progress.status == 'warning' %}#fbbf24{% else %}#f87171{% endif %};">
                        <strong>{{ weekly_progress.percentage|round(1) }}%</strong>
                    </div>
                </div>
                
                <!-- STATUS MESSAGE -->
                <div class="text-center">
                    <small style="color:var(--link);">
                        {% if weekly_progress.spending == 0 %}
                        âœ¨ Belum ada pengeluaran minggu ini
                        {% elif weekly_progress.status == 'success' %}
                        âœ… BAGUS
                        {% elif weekly_progress.status == 'warning' %}
                        âš ï¸ HATI-HATI
                        {% else %}
                        âŒ OVER BUDGET
                        {% endif %}
                    </small>
                </div>
            </div>
            {% else %}
            <div class="text-center py-4">
                <div class="mb-3">
                    <span style="font-size: 3rem;">ğŸ“ˆ</span>
                </div>
                <small style="color:var(--link);">
                    ğŸ’¡ Tambahkan data untuk melihat progress mingguan
                </small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ===== REKOMENDASI BUDGET PER KATEGORI ===== -->
<div class="mb-4">
    <h5 class="fw-bold mb-3" style="color:var(--text);">ğŸ’¡ Rekomendasi Budget Per Kategori</h5>

    {% for rec in budget_recommendations %}
    <div class="p-3 rounded mb-3 box-section"
        style="border-left:4px solid {% if rec.status == 'over' %}#f87171{% elif rec.status == 'warning' %}#fbbf24{% else %}#34d399{% endif %};">
        <div class="row">
            <div class="col-md-8">
                <h6 class="fw-bold mb-2" style="color:var(--text);">
                    {{ rec.category }}
                    <span class="badge ms-2"
                        style="background:{% if rec.status == 'over' %}#f87171{% elif rec.status == 'warning' %}#fbbf24{% else %}#34d399{% endif %}; font-size:11px;">
                        {% if rec.status == 'over' %}OVER BUDGET{% elif rec.status == 'warning' %}MENDEKATI LIMIT{% else
                        %}OK{% endif %}
                    </span>
                </h6>

                <div class="row g-2 mb-2">
                    <div class="col-md-6">
                        <small style="color:var(--link);">ğŸ“Š Bulan Ini (s/d hari ke-{{ current_day }})</small>
                        <div><strong style="color:var(--text);">Rp {{ "{:,}".format(rec.current_total|int) }}</strong>
                            <small style="color:var(--link);">(~Rp {{ "{:,}".format(rec.current_daily|int)
                                }}/hari)</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <small style="color:var(--link);">ğŸ¯ Target Ideal ({{ rec.percentage|int }}% dari
                            income)</small>
                        <div><strong style="color:var(--text);">Rp {{ "{:,}".format(rec.ideal_monthly|int) }}</strong>
                            <small style="color:var(--link);">/bulan</small>
                        </div>
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <small style="color:var(--link);">Budget Harian</small>
                        <div><strong style="color:#60a5fa;">Rp {{ "{:,}".format(rec.ideal_daily|int) }}</strong></div>
                    </div>
                    <div class="col-md-4">
                        <small style="color:var(--link);">Budget Mingguan</small>
                        <div><strong style="color:#60a5fa;">Rp {{ "{:,}".format(rec.ideal_weekly|int) }}</strong></div>
                    </div>
                    <div class="col-md-4">
                        <small style="color:var(--link);">Sisa Budget Bulan Ini</small>
                        <div><strong
                                style="color:{% if rec.remaining_budget >= 0 %}#34d399{% else %}#f87171{% endif %};">
                                Rp {{ "{:,}".format(rec.remaining_budget|int) }}
                            </strong></div>
                    </div>
                </div>

                <div class="alert-custom mb-2"
                    style="background:{% if rec.today_status == 'success' %}rgba(52,211,153,0.1){% elif rec.today_status == 'warning' %}rgba(251,191,36,0.1){% else %}rgba(248,113,113,0.1){% endif %}; border:1px solid {% if rec.today_status == 'success' %}#34d399{% elif rec.today_status == 'warning' %}#fbbf24{% else %}#f87171{% endif %};">
                    <small style="color:var(--text);">
                        <strong>Hari ini:</strong> Rp {{ "{:,}".format(rec.today_amount|int) }} / Rp {{
                        "{:,}".format(rec.ideal_daily|int) }}
                        {% if rec.today_diff > 0 %}
                        <span style="color:#f87171;">(lebih Rp {{ "{:,}".format(rec.today_diff|int) }})</span>
                        {% elif rec.today_diff < 0 %} <span style="color:#34d399;">(hemat Rp {{
                            "{:,}".format(rec.today_diff|int|abs) }})</span>
                            {% else %}
                            <span style="color:#34d399;">âœ“ Pas target!</span>
                            {% endif %}
                    </small>
                </div>

                {% if rec.status in ['over', 'warning'] and rec.remaining_budget < 0 %} <div class="alert-custom mb-0"
                    style="background:rgba(251,191,36,0.1); border:1px solid #fbbf24;">
                    <small style="color:var(--text);">
                        âš ï¸ <strong>Aksi diperlukan:</strong> Budget kategori ini sudah habis. Sisa {{ days_remaining }}
                        hari, usahakan maksimal <strong>Rp {{ "{:,}".format(rec.remaining_daily|int if
                            rec.remaining_daily > 0 else 0) }}/hari</strong>.
                    </small>
            </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            {% if rec.saving_potential > 0 %}
            <div class="text-center p-2 rounded mb-2"
                style="background:rgba(52,211,153,0.1); border:1px solid #34d399;">
                <small style="color:var(--link);">ğŸ’° Potensi Hemat</small>
                <div><strong style="color:#34d399; font-size:20px;">Rp {{ "{:,}".format(rec.saving_potential|int)
                        }}</strong></div>
                <small style="color:var(--link);">/bulan</small>
            </div>
            {% endif %}

            {% if rec.tips %}
            <div class="p-2 rounded" style="background:var(--card-bg); border:1px solid var(--card-border);">
                <small class="fw-bold" style="color:var(--text);">ğŸ’¡ Tips (opsional):</small>
                <ul class="mb-0 mt-1 ps-3" style="font-size:12px;">
                    {% for tip in rec.tips %}
                    <li style="color:var(--link);">{{ tip }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}

{% if total_saving_potential > 0 %}
<div class="alert-custom text-center" style="background:rgba(167,139,250,0.15); border:2px solid #a78bfa;">
    <h6 class="fw-bold mb-2" style="color:var(--text);">
        ğŸ¯ Total Potensi Penghematan: <span style="color:#a78bfa;">Rp {{ "{:,}".format(total_saving_potential|int)
            }}</span>
    </h6>
    <small style="color:var(--link);">Jika mengikuti budget ideal di semua kategori</small>
</div>
{% endif %}
</div>

<!-- ===== REKOMENDASI USER PERSONAL ===== -->
{% if user_recommendation %}
<div class="p-4 rounded mb-4 shadow-lg" style="background:var(--card-bg); border:1px solid var(--card-border);">
    <h4 class="fw-bold mb-3" style="color:var(--text);">ğŸ” Rekomendasi Anggaran Pribadi </h4>

    <div class="mb-3">
        <strong style="color:var(--text);">ğŸƒ Gaya hidup: </strong>
        <span style="color:var(--link); text-transform: capitalize;">{{ user_recommendation.lifestyle }}</span>
    </div>

    <div class="mb-4">
        <strong style="color:var(--text);">ğŸ’° Uang bulanan:</strong>
        <span style="color:var(--link);">Rp {{ "{:,}".format(user_recommendation.income|int) }}</span>
    </div>

    <hr style="border-color:var(--card-border);">

    <h5 class="fw-bold mb-3" style="color:var(--text);">ğŸ“Š Rekomendasi Anggaran EduBudget</h5>

    <div class="row">
        {% for item in user_recommendation.recommendations %}
        <div class="col-12 col-md-6 mb-2">
            <div class="p-3 rounded" style="background:var(--bg-second); border:1px solid var(--card-border);">
                <div class="d-flex justify-content-between">
                    <span style="color:var(--text); font-weight: 600;">âœ“ 
                        {% if item.category == 'Food' %}Makanan/Minuman
                        {% elif item.category == 'Transportation' %}Transportasi
                        {% elif item.category == 'Entertainment' %}Hiburan
                        {% elif item.category == 'Shopping' %}Belanja
                        {% elif item.category == 'Education' %}Pendidikan
                        {% elif item.category == 'Health' %}Kesehatan
                        {% elif item.category == 'Bills' %}Tagihan
                        {% elif item.category == 'Personal Care' %}Perawatan Diri
                        {% elif item.category == 'Social' %}Sosial
                        {% elif item.category == 'Flexible' %}Fleksibel
                        {% elif item.category == 'Emergency Fund' %}Dana Darurat
                        {% elif item.category == 'Self Improvement' %}Pengembangan Diri
                        {% elif item.category == 'Savings' %}Tabungan
                        {% else %}{{ item.category }}{% endif %}
                    </span>
                    <span style="color:var(--link); font-weight: 600;">Rp {{ "{:,}".format(item.amount|int) }}</span>
                </div>
                <div style="color:var(--text-faded); font-size: 13px;">({{ (item.fraction * 100)|round(1) }}%)</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <hr class="mt-4" style="border-color:var(--card-border);">

    <h5 class="fw-bold mb-2" style="color:var(--text);">ğŸ’¬ Insight Berdasarkan Gaya Hidup</h5>

    <div style="background:var(--bg-second); border:1px solid var(--card-border);" class="p-3 rounded mb-3">
        <strong style="color:var(--link); font-size:15px;">ğŸŸ¦ Mode: {{ user_recommendation.lifestyle|capitalize }}</strong>
        <p class="mt-2 mb-0" style="color:var(--text); font-size:14px;">{{ user_recommendation.description }}</p>
    </div>

    {% if user_recommendation.tips %}
    <div class="p-3 rounded" style="background:var(--bg-second); border:1px solid var(--card-border);">
        <h6 class="fw-bold mb-2" style="color:var(--text);">ğŸ’¡ Tips Khusus untuk Kamu</h6>
        <ul style="color:var(--link); font-size:14px; padding-left:18px;">
            {% for tip in user_recommendation.tips %}
            <li class="mb-1">{{ tip }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- ===== TIPS FINANSIAL ===== -->
<div class="p-3 rounded box-section">
    <h6 class="fw-bold mb-2" style="color:var(--text);">ğŸ“š Tips Kelola Keuangan Mahasiswa</h6>
    <ul class="mb-0" style="color:var(--link); font-size:14px;">
        <li>Catat pengeluaran setiap hari untuk tracking yang akurat</li>
        <li>Pisahkan uang bulanan ke amplop/rekening berbeda per kategori</li>
        <li>Gunakan metode 50/30/20: 50% kebutuhan, 30% keinginan, 20% tabungan</li>
        <li>Manfaatkan diskon/promo khusus mahasiswa (Spotify, Netflix, transport)</li>
        <li>Jangan malu bilang "gak ada budget" ke temen kalau diajak hangout mahal</li>
        <li>Emergency fund minimal Rp 500k untuk jaga-jaga</li>
    </ul>
</div>

<script>
    // ===== LOADING MANAGEMENT =====
    const loadingOverlay = document.getElementById('loading-overlay');
    const budgetForm = document.getElementById('budget-form');

    // Hide loading on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadingOverlay.classList.remove('show');
    });

    // ===== FORM SUBMISSION (POST -> REDIRECT -> GET) =====
    budgetForm.addEventListener('submit', function (e) {
        e.preventDefault();

        // Show loading
        loadingOverlay.classList.add('show');

        // Get form data
        const formData = new FormData(budgetForm);
        const target = formData.get('target') || 0;
        const lifestyle = formData.get('lifestyle') || 'moderat';

        // Redirect ke GET URL (no form submission dialog)
        window.location.href = `/analytics?target=${encodeURIComponent(target)}&lifestyle=${encodeURIComponent(lifestyle)}`;
    });

    // ===== PRESET TARGET HELPER =====
    function setTarget(amount) {
        document.getElementById('target-input').value = amount;
    }

    // ===== DEBUG LOG =====
    console.log('Analytics page loaded:', new Date().toISOString());
</script>

{% endblock %}
