{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold text-center mb-4">Dasbor</h2>

<!-- 3 Summary Card -->
<div class="row text-center g-3 mb-5">
    <div class="col-md-4">
        <div class="p-4 summary-card">
            <h5>Total Pemasukan</h5>
            <h2 class="text-success fw-bold">Rp {{ total_masuk | rupiah }}</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="p-4 summary-card">
            <h5>Total Pengeluaran</h5>
            <h2 class="text-danger fw-bold">Rp {{ total_keluar | rupiah }}</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="p-4 summary-card">
            <h5>Saldo</h5>
            <h2 class="text-info fw-bold">Rp {{ saldo | rupiah }}</h2>
        </div>
    </div>
</div>


<!-- Grafik -->
<div class="p-4 box-section mb-4 text-center">
    <h4 class="mb-3">Pengeluaran Berdasarkan Kategori</h4>

    <div style="width: 330px; height: 330px; margin: auto;">
        <canvas id="kategoriChart"></canvas>
    </div>
</div>


<!-- Form Input + Riwayat -->
<div class="row g-4">

    <!-- Form Input -->
    <div class="col-md-5">
        <div class="p-4 rounded box-section">
            <h4 class="mb-3">Tambah Transaksi</h4>

            <form action="/add" method="POST">

                <label class="mt-2">Tipe Transaksi</label>
                <select name="type" id="typeSelect" class="form-select">
                    <option value="pemasukan">Pemasukan</option>
                    <option value="pengeluaran">Pengeluaran</option>
                </select>

                <label class="mt-3">Kategori</label>
                <select name="category" id="categorySelect" class="form-select">
                    <!-- Options akan diisi oleh JavaScript -->
                </select>

                <label class="mt-3">Nominal</label>
                <input type="number" name="amount" class="form-control" placeholder="Masukkan nominal" required>

                <label class="mt-3">Mata Uang</label>
                <select name="currency" class="form-select">
                    <option>IDR</option>
                    <option>USD</option>
                    <option>EUR</option>
                    <option>JPY</option>
                </select>

                <label class="mt-3">Catatan</label>
                <textarea name="note" class="form-control" rows="2" placeholder="Catatan transaksi (opsional)"></textarea>

                <label class="mt-3">Tanggal</label>
                <input type="date" name="date" class="form-control" required>

                <button class="btn btn-primary w-100 mt-4 fw-bold">Simpan Transaksi</button>
            </form>
        </div>
    </div>

    <!-- Riwayat -->
<div class="col-md-7">
    <div class="p-4 rounded box-section">
        <h4 class="mb-3">Riwayat Terbaru</h4>

        {% if transactions %}
        <div class="dashboard-table"> <!-- Tambahkan class ini -->
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>KATEGORI</th>
                            <th>TIPE</th>
                            <th class="text-end">NOMINAL (IDR)</th>
                            <th class="text-center">TANGGAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in transactions %}
                        <tr>
                            <td>
                                <div class="table-category-container">
                                    <span class="table-emoji">
                                        {% if t[3] == 'pemasukan' %}ðŸ’°{% else %}ðŸ’¸{% endif %}
                                    </span>
                                    <span class="table-category-text">{{ t[2] }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="{% if t[3] == 'pemasukan' %}badge-income{% else %}badge-expense{% endif %}">
                                    {{ t[3].capitalize() }}
                                </span>
                            </td>
                            <td class="text-end">
                                <span class="table-amount {% if t[3] == 'pemasukan' %}text-success{% else %}text-danger{% endif %}">
                                    Rp {{ t[6] | rupiah }}
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="table-date-text">{{ t[8] }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted mb-0">Belum ada transaksi</p>
        </div>
        {% endif %}

        <div class="text-end mt-3">
            <a href="{{ url_for('history') }}" class="btn btn-outline-info btn-sm fw-bold">
                Lihat Semua Riwayat â†’
            </a>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ========== KATEGORI DINAMIS ==========
    const categories = {
        pemasukan: [
            "Uang Bulanan",
            "Gaji",
            "Transfer Orang Tua",
            "Beasiswa",
            "Freelance",
            "Lainnya"
        ],
        pengeluaran: [
            "Makanan/Minuman",
            "Bensin/Transportasi",
            "Laundry",
            "Hiburan",
            "Belanja",
            "Kuliah/Buku",
            "Pakaian",
            "Kos",
            "Internet/Pulsa",
            "Kesehatan",
            "Lainnya"
        ]
    };

    const typeSelect = document.getElementById("typeSelect");
    const categorySelect = document.getElementById("categorySelect");

    function updateCategories() {
        const type = typeSelect.value;
        const options = categories[type];
        
        categorySelect.innerHTML = "";
        
        options.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
        });
    }

    typeSelect.addEventListener("change", updateCategories);
    updateCategories(); // Load default categories on page load

    // ========== GRAFIK ==========
    const kategoriLabels = {{ kategori_data | map(attribute=0) | list | tojson }};
    const kategoriValues = {{ kategori_data | map(attribute=1) | list | tojson }};
    const chartColors = ["#3b82f6", "#eab308", "#ef4444", "#22c55e", "#a855f7", "#14b8a6", "#f97316", "#6b7280"];

    function buatChart() {
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--legend-text').trim();
        const ctx = document.getElementById('kategoriChart');

        if (ctx.chartInstance) ctx.chartInstance.destroy();

        ctx.chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: kategoriLabels,
                datasets: [{
                    data: kategoriValues,
                    backgroundColor: chartColors,
                    borderWidth: 2,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim()
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            color: legendColor,
                            font: { size: 13, weight: 600 },
                            padding: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: Rp ${value.toLocaleString('id-ID')} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    buatChart();

    new MutationObserver(() => buatChart())
        .observe(document.documentElement, { attributes: true, attributeFilter: ["data-theme"] });
</script>
{% endblock %}